"use strict";(()=>{var e={};e.id=718,e.ids=[718],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},79348:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},30412:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},61212:e=>{e.exports=require("async_hooks")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},20629:e=>{e.exports=require("fs/promises")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},74175:e=>{e.exports=require("tty")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},18075:(e,s,t)=>{t.r(s),t.d(s,{patchFetch:()=>g,routeModule:()=>y,serverHooks:()=>f,workAsyncStorage:()=>I,workUnitAsyncStorage:()=>D});var r={};t.r(r),t.d(r,{DELETE:()=>M,GET:()=>l,PUT:()=>R});var n=t(75122),o=t(57868),a=t(79769),c=t(91929),i=t(94451),u=t(85492),p=t(58837),d=t(22931);let A=new p.J;async function m(e){try{let s=new URL(e.url).pathname.split("/").pop();if(!s)return c.NextResponse.json({success:!1,error:{code:"BAD_REQUEST",message:"Company ID is required"}},{status:400});let t=await A.getCompanyById(s);return c.NextResponse.json({success:!0,data:t})}catch(e){if(e instanceof d.dR)return c.NextResponse.json({success:!1,error:{code:"NOT_FOUND",message:e.message}},{status:404});return console.error("Error fetching company:",e),c.NextResponse.json({success:!1,error:{code:"INTERNAL_ERROR",message:"Failed to fetch company"}},{status:500})}}async function N(e){try{let s=new URL(e.url).pathname.split("/").pop();if(!s)return c.NextResponse.json({success:!1,error:{code:"BAD_REQUEST",message:"Company ID is required"}},{status:400});let t=await e.json(),r={name:t.name,settings:t.settings,subscription:t.subscription},n=await A.updateCompany(s,r);return c.NextResponse.json({success:!0,data:n})}catch(e){if(e instanceof d.dR)return c.NextResponse.json({success:!1,error:{code:"NOT_FOUND",message:e.message}},{status:404});if(e instanceof d.p8)return c.NextResponse.json({success:!1,error:{code:"VALIDATION_ERROR",message:e.message}},{status:400});return console.error("Error updating company:",e),c.NextResponse.json({success:!1,error:{code:"INTERNAL_ERROR",message:"Failed to update company"}},{status:500})}}async function E(e){try{let s=new URL(e.url).pathname.split("/").pop();if(!s)return c.NextResponse.json({success:!1,error:{code:"BAD_REQUEST",message:"Company ID is required"}},{status:400});return await A.deleteCompany(s),c.NextResponse.json({success:!0,data:{message:"Company deleted successfully"}})}catch(e){if(e instanceof d.dR)return c.NextResponse.json({success:!1,error:{code:"NOT_FOUND",message:e.message}},{status:404});if(e instanceof d.p8)return c.NextResponse.json({success:!1,error:{code:"VALIDATION_ERROR",message:e.message}},{status:400});return console.error("Error deleting company:",e),c.NextResponse.json({success:!1,error:{code:"INTERNAL_ERROR",message:"Failed to delete company"}},{status:500})}}async function l(e){return(0,i.QO)(async e=>{if(!(0,u.Fs)(e.user.role,"companies","read"))return c.NextResponse.json({success:!1,error:{code:"FORBIDDEN",message:"Insufficient permissions"}},{status:403});let s=new URL(e.url).pathname.split("/").pop();return s&&!(0,u.BG)(e.user.companyId,s)?c.NextResponse.json({success:!1,error:{code:"FORBIDDEN",message:"Access denied to this company"}},{status:403}):m(e)})(e)}async function R(e){return(0,i.QO)(async e=>{if(!(0,u.Fs)(e.user.role,"companies","update"))return c.NextResponse.json({success:!1,error:{code:"FORBIDDEN",message:"Insufficient permissions"}},{status:403});let s=new URL(e.url).pathname.split("/").pop();return s&&!(0,u.BG)(e.user.companyId,s)?c.NextResponse.json({success:!1,error:{code:"FORBIDDEN",message:"Access denied to this company"}},{status:403}):N(e)})(e)}async function M(e){return(0,i.QO)(async e=>{if(!(0,u.Fs)(e.user.role,"companies","delete"))return c.NextResponse.json({success:!1,error:{code:"FORBIDDEN",message:"Insufficient permissions"}},{status:403});let s=new URL(e.url).pathname.split("/").pop();return s&&!(0,u.BG)(e.user.companyId,s)?c.NextResponse.json({success:!1,error:{code:"FORBIDDEN",message:"Access denied to this company"}},{status:403}):E(e)})(e)}let y=new n.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/companies/[id]/route",pathname:"/api/companies/[id]",filename:"route",bundlePath:"app/api/companies/[id]/route"},resolvedPagePath:"C:\\Users\\mnada\\Documents\\projectes\\InkGest\\apps\\web\\app\\api\\companies\\[id]\\route.ts",nextConfigOutput:"",userland:r}),{workAsyncStorage:I,workUnitAsyncStorage:D,serverHooks:f}=y;function g(){return(0,a.patchFetch)({workAsyncStorage:I,workUnitAsyncStorage:D})}},94451:(e,s,t)=>{t.d(s,{QO:()=>o});var r=t(91929),n=t(79953);function o(e){return async s=>{try{let t=await (0,n.getToken)({req:s,secret:process.env.NEXTAUTH_SECRET||"fallback-secret"});if(!t)return r.NextResponse.json({success:!1,error:{code:"UNAUTHORIZED",message:"Authentication required"}},{status:401});return s.user={id:t.id,email:t.email||"",name:t.name||"",role:t.role,companyId:t.companyId,storeIds:t.storeIds},await e(s)}catch(e){return console.error("Authentication middleware error:",e),r.NextResponse.json({success:!1,error:{code:"INTERNAL_ERROR",message:"Authentication failed"}},{status:500})}}}t(85492)},85492:(e,s,t)=>{t.d(s,{BG:()=>a,Fs:()=>n,YI:()=>o});let r={appointments:{create:["ADMIN","MANAGER","EMPLOYEE"],read:["ADMIN","MANAGER","EMPLOYEE","ARTIST"],update:["ADMIN","MANAGER","EMPLOYEE"],delete:["ADMIN","MANAGER"]},clients:{create:["ADMIN","MANAGER","EMPLOYEE"],read:["ADMIN","MANAGER","EMPLOYEE","ARTIST"],update:["ADMIN","MANAGER","EMPLOYEE"],delete:["ADMIN","MANAGER"]},artists:{create:["ADMIN","MANAGER"],read:["ADMIN","MANAGER","EMPLOYEE"],update:["ADMIN","MANAGER"],delete:["ADMIN","MANAGER"]},services:{create:["ADMIN","MANAGER"],read:["ADMIN","MANAGER","EMPLOYEE","ARTIST"],update:["ADMIN","MANAGER"],delete:["ADMIN","MANAGER"]},products:{create:["ADMIN","MANAGER"],read:["ADMIN","MANAGER","EMPLOYEE"],update:["ADMIN","MANAGER","EMPLOYEE"],delete:["ADMIN","MANAGER"]},reports:{read:["ADMIN","MANAGER"],export:["ADMIN","MANAGER"]},pos:{create:["ADMIN","MANAGER","EMPLOYEE"],read:["ADMIN","MANAGER","EMPLOYEE"],refund:["ADMIN","MANAGER"]},cash_register:{open:["ADMIN","MANAGER","EMPLOYEE"],close:["ADMIN","MANAGER"],read:["ADMIN","MANAGER"]},companies:{create:["ADMIN"],read:["ADMIN","MANAGER"],update:["ADMIN"],delete:["ADMIN"]},stores:{create:["ADMIN","MANAGER"],read:["ADMIN","MANAGER","EMPLOYEE","ARTIST"],update:["ADMIN","MANAGER"],delete:["ADMIN","MANAGER"]},users:{create:["ADMIN","MANAGER"],read:["ADMIN","MANAGER"],update:["ADMIN","MANAGER"],delete:["ADMIN"]}};function n(e,s,t){let n=r[s];if(!n)return!1;let o=n[t];return!!o&&o.includes(e)}function o(e,s){return e.includes(s)}function a(e,s){return e===s}},58837:(e,s,t)=>{t.d(s,{J:()=>o});var r=t(8063),n=t(22931);class o{async createCompany(e){if(!e.name?.trim())throw new n.p8("Company name is required");try{return await r.db.company.create({data:{name:e.name.trim(),settings:JSON.stringify(e.settings||{}),subscription:e.subscription||"basic"}})}catch(e){throw console.error("Error creating company:",e),Error("Failed to create company")}}async getCompanyById(e){let s=await r.db.company.findUnique({where:{id:e},include:{stores:!0,_count:{select:{users:!0,stores:!0}}}});if(!s)throw new n.dR("Company");return{...s,settings:JSON.parse(s.settings)}}async getAllCompanies(){return(await r.db.company.findMany({include:{stores:!0,_count:{select:{users:!0,stores:!0}}},orderBy:{createdAt:"desc"}})).map(e=>({...e,settings:JSON.parse(e.settings)}))}async updateCompany(e,s){if(!await r.db.company.findUnique({where:{id:e}}))throw new n.dR("Company");if(s.name&&!s.name.trim())throw new n.p8("Company name cannot be empty");try{let t={};s.name&&(t.name=s.name.trim()),s.settings&&(t.settings=JSON.stringify(s.settings)),s.subscription&&(t.subscription=s.subscription);let n=await r.db.company.update({where:{id:e},data:t});return{...n,settings:JSON.parse(n.settings)}}catch(e){throw console.error("Error updating company:",e),Error("Failed to update company")}}async deleteCompany(e){let s=await r.db.company.findUnique({where:{id:e},include:{_count:{select:{users:!0,stores:!0}}}});if(!s)throw new n.dR("Company");if(s._count.users>0||s._count.stores>0)throw new n.p8("Cannot delete company with existing users or stores");try{await r.db.company.delete({where:{id:e}})}catch(e){throw console.error("Error deleting company:",e),Error("Failed to delete company")}}async getCompanyStats(e){let s=await r.db.company.findUnique({where:{id:e},include:{stores:{include:{_count:{select:{clients:!0,appointments:!0}}}},_count:{select:{users:!0}}}});if(!s)throw new n.dR("Company");let t=s.stores.reduce((e,s)=>e+s._count.clients,0),o=s.stores.reduce((e,s)=>e+s._count.appointments,0),a=new Date;a.setDate(1),a.setHours(0,0,0,0);let c=(await r.db.appointment.findMany({where:{store:{companyId:e},createdAt:{gte:a},status:"COMPLETED"},select:{price:!0}})).reduce((e,s)=>e+s.price,0);return{totalUsers:s._count.users,totalStores:s.stores.length,totalClients:t,totalAppointments:o,monthlyRevenue:c}}}},22931:(e,s,t)=>{t.d(s,{dR:()=>o,p8:()=>n});class r extends Error{constructor(e,s=500,t="INTERNAL_ERROR",r=!0){super(e),this.message=e,this.statusCode=s,this.code=t,this.isOperational=r,this.name="AppError"}}class n extends r{constructor(e,s){super(e,400,"VALIDATION_ERROR"),this.name="ValidationError"}}class o extends r{constructor(e){super(`${e} not found`,404,"NOT_FOUND"),this.name="NotFoundError"}}}};var s=require("../../../../webpack-runtime.js");s.C(e);var t=e=>s(s.s=e),r=s.X(0,[921,714,929,906],()=>t(18075));module.exports=r})();