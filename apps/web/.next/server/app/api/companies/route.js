"use strict";(()=>{var e={};e.id=623,e.ids=[623],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},79348:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},30412:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},61212:e=>{e.exports=require("async_hooks")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},20629:e=>{e.exports=require("fs/promises")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},74175:e=>{e.exports=require("tty")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},26020:(e,t,r)=>{r.r(t),r.d(t,{patchFetch:()=>D,routeModule:()=>l,serverHooks:()=>I,workAsyncStorage:()=>R,workUnitAsyncStorage:()=>y});var s={};r.r(s),r.d(s,{GET:()=>m,POST:()=>M});var n=r(75122),o=r(57868),a=r(79769),i=r(91929),c=r(94451),u=r(85492),p=r(58837),d=r(22931);let A=new p.J;async function E(e){try{let e=await A.getAllCompanies();return i.NextResponse.json({success:!0,data:e})}catch(e){return console.error("Error fetching companies:",e),i.NextResponse.json({success:!1,error:{code:"INTERNAL_ERROR",message:"Failed to fetch companies"}},{status:500})}}async function N(e){try{let t=await e.json(),r={name:t.name,settings:t.settings,subscription:t.subscription},s=await A.createCompany(r);return i.NextResponse.json({success:!0,data:s},{status:201})}catch(e){if(e instanceof d.p8)return i.NextResponse.json({success:!1,error:{code:"VALIDATION_ERROR",message:e.message}},{status:400});return console.error("Error creating company:",e),i.NextResponse.json({success:!1,error:{code:"INTERNAL_ERROR",message:"Failed to create company"}},{status:500})}}async function m(e){return(0,c.QO)(async e=>(0,u.Fs)(e.user.role,"companies","read")?E(e):i.NextResponse.json({success:!1,error:{code:"FORBIDDEN",message:"Insufficient permissions"}},{status:403}))(e)}async function M(e){return(0,c.QO)(async e=>(0,u.Fs)(e.user.role,"companies","create")?N(e):i.NextResponse.json({success:!1,error:{code:"FORBIDDEN",message:"Insufficient permissions"}},{status:403}))(e)}let l=new n.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/companies/route",pathname:"/api/companies",filename:"route",bundlePath:"app/api/companies/route"},resolvedPagePath:"C:\\Users\\mnada\\Documents\\projectes\\InkGest\\apps\\web\\app\\api\\companies\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:R,workUnitAsyncStorage:y,serverHooks:I}=l;function D(){return(0,a.patchFetch)({workAsyncStorage:R,workUnitAsyncStorage:y})}},94451:(e,t,r)=>{r.d(t,{QO:()=>o});var s=r(91929),n=r(79953);function o(e){return async t=>{try{let r=await (0,n.getToken)({req:t,secret:process.env.NEXTAUTH_SECRET||"fallback-secret"});if(!r)return s.NextResponse.json({success:!1,error:{code:"UNAUTHORIZED",message:"Authentication required"}},{status:401});return t.user={id:r.id,email:r.email||"",name:r.name||"",role:r.role,companyId:r.companyId,storeIds:r.storeIds},await e(t)}catch(e){return console.error("Authentication middleware error:",e),s.NextResponse.json({success:!1,error:{code:"INTERNAL_ERROR",message:"Authentication failed"}},{status:500})}}}r(85492)},85492:(e,t,r)=>{r.d(t,{BG:()=>a,Fs:()=>n,YI:()=>o});let s={appointments:{create:["ADMIN","MANAGER","EMPLOYEE"],read:["ADMIN","MANAGER","EMPLOYEE","ARTIST"],update:["ADMIN","MANAGER","EMPLOYEE"],delete:["ADMIN","MANAGER"]},clients:{create:["ADMIN","MANAGER","EMPLOYEE"],read:["ADMIN","MANAGER","EMPLOYEE","ARTIST"],update:["ADMIN","MANAGER","EMPLOYEE"],delete:["ADMIN","MANAGER"]},artists:{create:["ADMIN","MANAGER"],read:["ADMIN","MANAGER","EMPLOYEE"],update:["ADMIN","MANAGER"],delete:["ADMIN","MANAGER"]},services:{create:["ADMIN","MANAGER"],read:["ADMIN","MANAGER","EMPLOYEE","ARTIST"],update:["ADMIN","MANAGER"],delete:["ADMIN","MANAGER"]},products:{create:["ADMIN","MANAGER"],read:["ADMIN","MANAGER","EMPLOYEE"],update:["ADMIN","MANAGER","EMPLOYEE"],delete:["ADMIN","MANAGER"]},reports:{read:["ADMIN","MANAGER"],export:["ADMIN","MANAGER"]},pos:{create:["ADMIN","MANAGER","EMPLOYEE"],read:["ADMIN","MANAGER","EMPLOYEE"],refund:["ADMIN","MANAGER"]},cash_register:{open:["ADMIN","MANAGER","EMPLOYEE"],close:["ADMIN","MANAGER"],read:["ADMIN","MANAGER"]},companies:{create:["ADMIN"],read:["ADMIN","MANAGER"],update:["ADMIN"],delete:["ADMIN"]},stores:{create:["ADMIN","MANAGER"],read:["ADMIN","MANAGER","EMPLOYEE","ARTIST"],update:["ADMIN","MANAGER"],delete:["ADMIN","MANAGER"]},users:{create:["ADMIN","MANAGER"],read:["ADMIN","MANAGER"],update:["ADMIN","MANAGER"],delete:["ADMIN"]}};function n(e,t,r){let n=s[t];if(!n)return!1;let o=n[r];return!!o&&o.includes(e)}function o(e,t){return e.includes(t)}function a(e,t){return e===t}},58837:(e,t,r)=>{r.d(t,{J:()=>o});var s=r(8063),n=r(22931);class o{async createCompany(e){if(!e.name?.trim())throw new n.p8("Company name is required");try{return await s.db.company.create({data:{name:e.name.trim(),settings:JSON.stringify(e.settings||{}),subscription:e.subscription||"basic"}})}catch(e){throw console.error("Error creating company:",e),Error("Failed to create company")}}async getCompanyById(e){let t=await s.db.company.findUnique({where:{id:e},include:{stores:!0,_count:{select:{users:!0,stores:!0}}}});if(!t)throw new n.dR("Company");return{...t,settings:JSON.parse(t.settings)}}async getAllCompanies(){return(await s.db.company.findMany({include:{stores:!0,_count:{select:{users:!0,stores:!0}}},orderBy:{createdAt:"desc"}})).map(e=>({...e,settings:JSON.parse(e.settings)}))}async updateCompany(e,t){if(!await s.db.company.findUnique({where:{id:e}}))throw new n.dR("Company");if(t.name&&!t.name.trim())throw new n.p8("Company name cannot be empty");try{let r={};t.name&&(r.name=t.name.trim()),t.settings&&(r.settings=JSON.stringify(t.settings)),t.subscription&&(r.subscription=t.subscription);let n=await s.db.company.update({where:{id:e},data:r});return{...n,settings:JSON.parse(n.settings)}}catch(e){throw console.error("Error updating company:",e),Error("Failed to update company")}}async deleteCompany(e){let t=await s.db.company.findUnique({where:{id:e},include:{_count:{select:{users:!0,stores:!0}}}});if(!t)throw new n.dR("Company");if(t._count.users>0||t._count.stores>0)throw new n.p8("Cannot delete company with existing users or stores");try{await s.db.company.delete({where:{id:e}})}catch(e){throw console.error("Error deleting company:",e),Error("Failed to delete company")}}async getCompanyStats(e){let t=await s.db.company.findUnique({where:{id:e},include:{stores:{include:{_count:{select:{clients:!0,appointments:!0}}}},_count:{select:{users:!0}}}});if(!t)throw new n.dR("Company");let r=t.stores.reduce((e,t)=>e+t._count.clients,0),o=t.stores.reduce((e,t)=>e+t._count.appointments,0),a=new Date;a.setDate(1),a.setHours(0,0,0,0);let i=(await s.db.appointment.findMany({where:{store:{companyId:e},createdAt:{gte:a},status:"COMPLETED"},select:{price:!0}})).reduce((e,t)=>e+t.price,0);return{totalUsers:t._count.users,totalStores:t.stores.length,totalClients:r,totalAppointments:o,monthlyRevenue:i}}}},22931:(e,t,r)=>{r.d(t,{dR:()=>o,p8:()=>n});class s extends Error{constructor(e,t=500,r="INTERNAL_ERROR",s=!0){super(e),this.message=e,this.statusCode=t,this.code=r,this.isOperational=s,this.name="AppError"}}class n extends s{constructor(e,t){super(e,400,"VALIDATION_ERROR"),this.name="ValidationError"}}class o extends s{constructor(e){super(`${e} not found`,404,"NOT_FOUND"),this.name="NotFoundError"}}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[921,714,929,906],()=>r(26020));module.exports=s})();