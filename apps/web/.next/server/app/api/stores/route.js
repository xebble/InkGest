"use strict";(()=>{var e={};e.id=593,e.ids=[593],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},79348:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},30412:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},61212:e=>{e.exports=require("async_hooks")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},20629:e=>{e.exports=require("fs/promises")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},74175:e=>{e.exports=require("tty")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},64291:(e,t,r)=>{r.r(t),r.d(t,{patchFetch:()=>w,routeModule:()=>m,serverHooks:()=>f,workAsyncStorage:()=>R,workUnitAsyncStorage:()=>I});var s={};r.r(s),r.d(s,{GET:()=>l,POST:()=>M});var o=r(75122),n=r(57868),a=r(79769),i=r(91929),c=r(94451),u=r(85492),d=r(95934),p=r(22931);let A=new d.d;async function N(e){try{let t;let r=new URL(e.url).searchParams.get("companyId");return t=r?await A.getStoresByCompanyId(r):await A.getAccessibleStores(e.user.storeIds),i.NextResponse.json({success:!0,data:t})}catch(e){return console.error("Error fetching stores:",e),i.NextResponse.json({success:!1,error:{code:"INTERNAL_ERROR",message:"Failed to fetch stores"}},{status:500})}}async function E(e){try{let t=await e.json(),r={companyId:t.companyId||e.user.companyId,name:t.name,configuration:t.configuration,timezone:t.timezone,businessHours:t.businessHours};if(r.companyId!==e.user.companyId)return i.NextResponse.json({success:!1,error:{code:"FORBIDDEN",message:"Cannot create store in different company"}},{status:403});let s=await A.createStore(r);return i.NextResponse.json({success:!0,data:s},{status:201})}catch(e){if(e instanceof p.p8)return i.NextResponse.json({success:!1,error:{code:"VALIDATION_ERROR",message:e.message}},{status:400});return console.error("Error creating store:",e),i.NextResponse.json({success:!1,error:{code:"INTERNAL_ERROR",message:"Failed to create store"}},{status:500})}}async function l(e){return(0,c.QO)(async e=>(0,u.Fs)(e.user.role,"stores","read")?N(e):i.NextResponse.json({success:!1,error:{code:"FORBIDDEN",message:"Insufficient permissions"}},{status:403}))(e)}async function M(e){return(0,c.QO)(async e=>(0,u.Fs)(e.user.role,"stores","create")?E(e):i.NextResponse.json({success:!1,error:{code:"FORBIDDEN",message:"Insufficient permissions"}},{status:403}))(e)}let m=new o.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/stores/route",pathname:"/api/stores",filename:"route",bundlePath:"app/api/stores/route"},resolvedPagePath:"C:\\Users\\mnada\\Documents\\projectes\\InkGest\\apps\\web\\app\\api\\stores\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:R,workUnitAsyncStorage:I,serverHooks:f}=m;function w(){return(0,a.patchFetch)({workAsyncStorage:R,workUnitAsyncStorage:I})}},94451:(e,t,r)=>{r.d(t,{QO:()=>n});var s=r(91929),o=r(79953);function n(e){return async t=>{try{let r=await (0,o.getToken)({req:t,secret:process.env.NEXTAUTH_SECRET||"fallback-secret"});if(!r)return s.NextResponse.json({success:!1,error:{code:"UNAUTHORIZED",message:"Authentication required"}},{status:401});return t.user={id:r.id,email:r.email||"",name:r.name||"",role:r.role,companyId:r.companyId,storeIds:r.storeIds},await e(t)}catch(e){return console.error("Authentication middleware error:",e),s.NextResponse.json({success:!1,error:{code:"INTERNAL_ERROR",message:"Authentication failed"}},{status:500})}}}r(85492)},85492:(e,t,r)=>{r.d(t,{BG:()=>a,Fs:()=>o,YI:()=>n});let s={appointments:{create:["ADMIN","MANAGER","EMPLOYEE"],read:["ADMIN","MANAGER","EMPLOYEE","ARTIST"],update:["ADMIN","MANAGER","EMPLOYEE"],delete:["ADMIN","MANAGER"]},clients:{create:["ADMIN","MANAGER","EMPLOYEE"],read:["ADMIN","MANAGER","EMPLOYEE","ARTIST"],update:["ADMIN","MANAGER","EMPLOYEE"],delete:["ADMIN","MANAGER"]},artists:{create:["ADMIN","MANAGER"],read:["ADMIN","MANAGER","EMPLOYEE"],update:["ADMIN","MANAGER"],delete:["ADMIN","MANAGER"]},services:{create:["ADMIN","MANAGER"],read:["ADMIN","MANAGER","EMPLOYEE","ARTIST"],update:["ADMIN","MANAGER"],delete:["ADMIN","MANAGER"]},products:{create:["ADMIN","MANAGER"],read:["ADMIN","MANAGER","EMPLOYEE"],update:["ADMIN","MANAGER","EMPLOYEE"],delete:["ADMIN","MANAGER"]},reports:{read:["ADMIN","MANAGER"],export:["ADMIN","MANAGER"]},pos:{create:["ADMIN","MANAGER","EMPLOYEE"],read:["ADMIN","MANAGER","EMPLOYEE"],refund:["ADMIN","MANAGER"]},cash_register:{open:["ADMIN","MANAGER","EMPLOYEE"],close:["ADMIN","MANAGER"],read:["ADMIN","MANAGER"]},companies:{create:["ADMIN"],read:["ADMIN","MANAGER"],update:["ADMIN"],delete:["ADMIN"]},stores:{create:["ADMIN","MANAGER"],read:["ADMIN","MANAGER","EMPLOYEE","ARTIST"],update:["ADMIN","MANAGER"],delete:["ADMIN","MANAGER"]},users:{create:["ADMIN","MANAGER"],read:["ADMIN","MANAGER"],update:["ADMIN","MANAGER"],delete:["ADMIN"]}};function o(e,t,r){let o=s[t];if(!o)return!1;let n=o[r];return!!n&&n.includes(e)}function n(e,t){return e.includes(t)}function a(e,t){return e===t}},95934:(e,t,r)=>{r.d(t,{d:()=>n});var s=r(8063),o=r(22931);class n{async createStore(e){if(!e.name?.trim())throw new o.p8("Store name is required");if(!e.companyId)throw new o.p8("Company ID is required");if(!await s.db.company.findUnique({where:{id:e.companyId}}))throw new o.dR("Company");try{let t=await s.db.store.create({data:{companyId:e.companyId,name:e.name.trim(),configuration:JSON.stringify(e.configuration||{}),timezone:e.timezone||"Europe/Madrid",businessHours:JSON.stringify(e.businessHours)}});return{...t,configuration:JSON.parse(t.configuration),businessHours:JSON.parse(t.businessHours)}}catch(e){throw console.error("Error creating store:",e),Error("Failed to create store")}}async getStoreById(e){let t=await s.db.store.findUnique({where:{id:e},include:{_count:{select:{clients:!0,artists:!0,appointments:!0,services:!0,products:!0}}}});if(!t)throw new o.dR("Store");return{...t,configuration:JSON.parse(t.configuration),businessHours:JSON.parse(t.businessHours)}}async getStoresByCompanyId(e){return(await s.db.store.findMany({where:{companyId:e},include:{_count:{select:{clients:!0,artists:!0,appointments:!0,services:!0,products:!0}}},orderBy:{name:"asc"}})).map(e=>({...e,configuration:JSON.parse(e.configuration),businessHours:JSON.parse(e.businessHours)}))}async getAccessibleStores(e){return 0===e.length?[]:(await s.db.store.findMany({where:{id:{in:e}},include:{_count:{select:{clients:!0,artists:!0,appointments:!0,services:!0,products:!0}}},orderBy:{name:"asc"}})).map(e=>({...e,configuration:JSON.parse(e.configuration),businessHours:JSON.parse(e.businessHours)}))}async updateStore(e,t){if(!await s.db.store.findUnique({where:{id:e}}))throw new o.dR("Store");if(t.name&&!t.name.trim())throw new o.p8("Store name cannot be empty");try{let r={};t.name&&(r.name=t.name.trim()),t.configuration&&(r.configuration=JSON.stringify(t.configuration)),t.timezone&&(r.timezone=t.timezone),t.businessHours&&(r.businessHours=JSON.stringify(t.businessHours));let o=await s.db.store.update({where:{id:e},data:r});return{...o,configuration:JSON.parse(o.configuration),businessHours:JSON.parse(o.businessHours)}}catch(e){throw console.error("Error updating store:",e),Error("Failed to update store")}}async deleteStore(e){let t=await s.db.store.findUnique({where:{id:e},include:{_count:{select:{clients:!0,artists:!0,appointments:!0}}}});if(!t)throw new o.dR("Store");if(t._count.clients>0||t._count.artists>0||t._count.appointments>0)throw new o.p8("Cannot delete store with existing data");try{await s.db.store.delete({where:{id:e}})}catch(e){throw console.error("Error deleting store:",e),Error("Failed to delete store")}}async getStoreStats(e){let t=await s.db.store.findUnique({where:{id:e},include:{_count:{select:{clients:!0,artists:!0,appointments:!0}}}});if(!t)throw new o.dR("Store");let r=await s.db.appointment.count({where:{storeId:e,status:"COMPLETED"}}),n=new Date;n.setDate(1),n.setHours(0,0,0,0);let a=(await s.db.appointment.findMany({where:{storeId:e,createdAt:{gte:n},status:"COMPLETED"},select:{price:!0}})).reduce((e,t)=>e+t.price,0),i=await s.db.appointment.findMany({where:{storeId:e,status:"COMPLETED"},select:{price:!0}}),c=i.reduce((e,t)=>e+t.price,0),u=i.length>0?c/i.length:0;return{totalClients:t._count.clients,totalArtists:t._count.artists,totalAppointments:t._count.appointments,completedAppointments:r,monthlyRevenue:a,averageAppointmentValue:u}}}},22931:(e,t,r)=>{r.d(t,{dR:()=>n,p8:()=>o});class s extends Error{constructor(e,t=500,r="INTERNAL_ERROR",s=!0){super(e),this.message=e,this.statusCode=t,this.code=r,this.isOperational=s,this.name="AppError"}}class o extends s{constructor(e,t){super(e,400,"VALIDATION_ERROR"),this.name="ValidationError"}}class n extends s{constructor(e){super(`${e} not found`,404,"NOT_FOUND"),this.name="NotFoundError"}}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[921,714,929,906],()=>r(64291));module.exports=s})();