"use strict";(()=>{var e={};e.id=545,e.ids=[545],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},79348:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},30412:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},61212:e=>{e.exports=require("async_hooks")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},20629:e=>{e.exports=require("fs/promises")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},74175:e=>{e.exports=require("tty")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},53e3:(e,s,t)=>{t.r(s),t.d(s,{patchFetch:()=>h,routeModule:()=>I,serverHooks:()=>g,workAsyncStorage:()=>f,workUnitAsyncStorage:()=>D});var r={};t.r(r),t.d(r,{DELETE:()=>M,GET:()=>R,PUT:()=>m});var o=t(75122),n=t(57868),a=t(79769),i=t(91929),u=t(94451),c=t(85492),d=t(95934),p=t(22931);let A=new d.d;async function N(e){try{let s=new URL(e.url).pathname.split("/").pop();if(!s)return i.NextResponse.json({success:!1,error:{code:"BAD_REQUEST",message:"Store ID is required"}},{status:400});let t=await A.getStoreById(s);return i.NextResponse.json({success:!0,data:t})}catch(e){if(e instanceof p.dR)return i.NextResponse.json({success:!1,error:{code:"NOT_FOUND",message:e.message}},{status:404});return console.error("Error fetching store:",e),i.NextResponse.json({success:!1,error:{code:"INTERNAL_ERROR",message:"Failed to fetch store"}},{status:500})}}async function E(e){try{let s=new URL(e.url).pathname.split("/").pop();if(!s)return i.NextResponse.json({success:!1,error:{code:"BAD_REQUEST",message:"Store ID is required"}},{status:400});let t=await e.json(),r={name:t.name,configuration:t.configuration,timezone:t.timezone,businessHours:t.businessHours},o=await A.updateStore(s,r);return i.NextResponse.json({success:!0,data:o})}catch(e){if(e instanceof p.dR)return i.NextResponse.json({success:!1,error:{code:"NOT_FOUND",message:e.message}},{status:404});if(e instanceof p.p8)return i.NextResponse.json({success:!1,error:{code:"VALIDATION_ERROR",message:e.message}},{status:400});return console.error("Error updating store:",e),i.NextResponse.json({success:!1,error:{code:"INTERNAL_ERROR",message:"Failed to update store"}},{status:500})}}async function l(e){try{let s=new URL(e.url).pathname.split("/").pop();if(!s)return i.NextResponse.json({success:!1,error:{code:"BAD_REQUEST",message:"Store ID is required"}},{status:400});return await A.deleteStore(s),i.NextResponse.json({success:!0,data:{message:"Store deleted successfully"}})}catch(e){if(e instanceof p.dR)return i.NextResponse.json({success:!1,error:{code:"NOT_FOUND",message:e.message}},{status:404});if(e instanceof p.p8)return i.NextResponse.json({success:!1,error:{code:"VALIDATION_ERROR",message:e.message}},{status:400});return i.NextResponse.json({success:!1,error:{code:"INTERNAL_ERROR",message:"Failed to delete store"}},{status:500})}}async function R(e){return(0,u.QO)(async e=>{if(!(0,c.Fs)(e.user.role,"stores","read"))return i.NextResponse.json({success:!1,error:{code:"FORBIDDEN",message:"Insufficient permissions"}},{status:403});let s=new URL(e.url).pathname.split("/").pop();return s&&!(0,c.YI)(e.user.storeIds,s)?i.NextResponse.json({success:!1,error:{code:"FORBIDDEN",message:"Access denied to this store"}},{status:403}):N(e)})(e)}async function m(e){return(0,u.QO)(async e=>{if(!(0,c.Fs)(e.user.role,"stores","update"))return i.NextResponse.json({success:!1,error:{code:"FORBIDDEN",message:"Insufficient permissions"}},{status:403});let s=new URL(e.url).pathname.split("/").pop();return s&&!(0,c.YI)(e.user.storeIds,s)?i.NextResponse.json({success:!1,error:{code:"FORBIDDEN",message:"Access denied to this store"}},{status:403}):E(e)})(e)}async function M(e){return(0,u.QO)(async e=>{if(!(0,c.Fs)(e.user.role,"stores","delete"))return i.NextResponse.json({success:!1,error:{code:"FORBIDDEN",message:"Insufficient permissions"}},{status:403});let s=new URL(e.url).pathname.split("/").pop();return s&&!(0,c.YI)(e.user.storeIds,s)?i.NextResponse.json({success:!1,error:{code:"FORBIDDEN",message:"Access denied to this store"}},{status:403}):l(e)})(e)}let I=new o.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/stores/[id]/route",pathname:"/api/stores/[id]",filename:"route",bundlePath:"app/api/stores/[id]/route"},resolvedPagePath:"C:\\Users\\mnada\\Documents\\projectes\\InkGest\\apps\\web\\app\\api\\stores\\[id]\\route.ts",nextConfigOutput:"",userland:r}),{workAsyncStorage:f,workUnitAsyncStorage:D,serverHooks:g}=I;function h(){return(0,a.patchFetch)({workAsyncStorage:f,workUnitAsyncStorage:D})}},94451:(e,s,t)=>{t.d(s,{QO:()=>n});var r=t(91929),o=t(79953);function n(e){return async s=>{try{let t=await (0,o.getToken)({req:s,secret:process.env.NEXTAUTH_SECRET||"fallback-secret"});if(!t)return r.NextResponse.json({success:!1,error:{code:"UNAUTHORIZED",message:"Authentication required"}},{status:401});return s.user={id:t.id,email:t.email||"",name:t.name||"",role:t.role,companyId:t.companyId,storeIds:t.storeIds},await e(s)}catch(e){return console.error("Authentication middleware error:",e),r.NextResponse.json({success:!1,error:{code:"INTERNAL_ERROR",message:"Authentication failed"}},{status:500})}}}t(85492)},85492:(e,s,t)=>{t.d(s,{BG:()=>a,Fs:()=>o,YI:()=>n});let r={appointments:{create:["ADMIN","MANAGER","EMPLOYEE"],read:["ADMIN","MANAGER","EMPLOYEE","ARTIST"],update:["ADMIN","MANAGER","EMPLOYEE"],delete:["ADMIN","MANAGER"]},clients:{create:["ADMIN","MANAGER","EMPLOYEE"],read:["ADMIN","MANAGER","EMPLOYEE","ARTIST"],update:["ADMIN","MANAGER","EMPLOYEE"],delete:["ADMIN","MANAGER"]},artists:{create:["ADMIN","MANAGER"],read:["ADMIN","MANAGER","EMPLOYEE"],update:["ADMIN","MANAGER"],delete:["ADMIN","MANAGER"]},services:{create:["ADMIN","MANAGER"],read:["ADMIN","MANAGER","EMPLOYEE","ARTIST"],update:["ADMIN","MANAGER"],delete:["ADMIN","MANAGER"]},products:{create:["ADMIN","MANAGER"],read:["ADMIN","MANAGER","EMPLOYEE"],update:["ADMIN","MANAGER","EMPLOYEE"],delete:["ADMIN","MANAGER"]},reports:{read:["ADMIN","MANAGER"],export:["ADMIN","MANAGER"]},pos:{create:["ADMIN","MANAGER","EMPLOYEE"],read:["ADMIN","MANAGER","EMPLOYEE"],refund:["ADMIN","MANAGER"]},cash_register:{open:["ADMIN","MANAGER","EMPLOYEE"],close:["ADMIN","MANAGER"],read:["ADMIN","MANAGER"]},companies:{create:["ADMIN"],read:["ADMIN","MANAGER"],update:["ADMIN"],delete:["ADMIN"]},stores:{create:["ADMIN","MANAGER"],read:["ADMIN","MANAGER","EMPLOYEE","ARTIST"],update:["ADMIN","MANAGER"],delete:["ADMIN","MANAGER"]},users:{create:["ADMIN","MANAGER"],read:["ADMIN","MANAGER"],update:["ADMIN","MANAGER"],delete:["ADMIN"]}};function o(e,s,t){let o=r[s];if(!o)return!1;let n=o[t];return!!n&&n.includes(e)}function n(e,s){return e.includes(s)}function a(e,s){return e===s}},95934:(e,s,t)=>{t.d(s,{d:()=>n});var r=t(8063),o=t(22931);class n{async createStore(e){if(!e.name?.trim())throw new o.p8("Store name is required");if(!e.companyId)throw new o.p8("Company ID is required");if(!await r.db.company.findUnique({where:{id:e.companyId}}))throw new o.dR("Company");try{let s=await r.db.store.create({data:{companyId:e.companyId,name:e.name.trim(),configuration:JSON.stringify(e.configuration||{}),timezone:e.timezone||"Europe/Madrid",businessHours:JSON.stringify(e.businessHours)}});return{...s,configuration:JSON.parse(s.configuration),businessHours:JSON.parse(s.businessHours)}}catch(e){throw console.error("Error creating store:",e),Error("Failed to create store")}}async getStoreById(e){let s=await r.db.store.findUnique({where:{id:e},include:{_count:{select:{clients:!0,artists:!0,appointments:!0,services:!0,products:!0}}}});if(!s)throw new o.dR("Store");return{...s,configuration:JSON.parse(s.configuration),businessHours:JSON.parse(s.businessHours)}}async getStoresByCompanyId(e){return(await r.db.store.findMany({where:{companyId:e},include:{_count:{select:{clients:!0,artists:!0,appointments:!0,services:!0,products:!0}}},orderBy:{name:"asc"}})).map(e=>({...e,configuration:JSON.parse(e.configuration),businessHours:JSON.parse(e.businessHours)}))}async getAccessibleStores(e){return 0===e.length?[]:(await r.db.store.findMany({where:{id:{in:e}},include:{_count:{select:{clients:!0,artists:!0,appointments:!0,services:!0,products:!0}}},orderBy:{name:"asc"}})).map(e=>({...e,configuration:JSON.parse(e.configuration),businessHours:JSON.parse(e.businessHours)}))}async updateStore(e,s){if(!await r.db.store.findUnique({where:{id:e}}))throw new o.dR("Store");if(s.name&&!s.name.trim())throw new o.p8("Store name cannot be empty");try{let t={};s.name&&(t.name=s.name.trim()),s.configuration&&(t.configuration=JSON.stringify(s.configuration)),s.timezone&&(t.timezone=s.timezone),s.businessHours&&(t.businessHours=JSON.stringify(s.businessHours));let o=await r.db.store.update({where:{id:e},data:t});return{...o,configuration:JSON.parse(o.configuration),businessHours:JSON.parse(o.businessHours)}}catch(e){throw console.error("Error updating store:",e),Error("Failed to update store")}}async deleteStore(e){let s=await r.db.store.findUnique({where:{id:e},include:{_count:{select:{clients:!0,artists:!0,appointments:!0}}}});if(!s)throw new o.dR("Store");if(s._count.clients>0||s._count.artists>0||s._count.appointments>0)throw new o.p8("Cannot delete store with existing data");try{await r.db.store.delete({where:{id:e}})}catch(e){throw console.error("Error deleting store:",e),Error("Failed to delete store")}}async getStoreStats(e){let s=await r.db.store.findUnique({where:{id:e},include:{_count:{select:{clients:!0,artists:!0,appointments:!0}}}});if(!s)throw new o.dR("Store");let t=await r.db.appointment.count({where:{storeId:e,status:"COMPLETED"}}),n=new Date;n.setDate(1),n.setHours(0,0,0,0);let a=(await r.db.appointment.findMany({where:{storeId:e,createdAt:{gte:n},status:"COMPLETED"},select:{price:!0}})).reduce((e,s)=>e+s.price,0),i=await r.db.appointment.findMany({where:{storeId:e,status:"COMPLETED"},select:{price:!0}}),u=i.reduce((e,s)=>e+s.price,0),c=i.length>0?u/i.length:0;return{totalClients:s._count.clients,totalArtists:s._count.artists,totalAppointments:s._count.appointments,completedAppointments:t,monthlyRevenue:a,averageAppointmentValue:c}}}},22931:(e,s,t)=>{t.d(s,{dR:()=>n,p8:()=>o});class r extends Error{constructor(e,s=500,t="INTERNAL_ERROR",r=!0){super(e),this.message=e,this.statusCode=s,this.code=t,this.isOperational=r,this.name="AppError"}}class o extends r{constructor(e,s){super(e,400,"VALIDATION_ERROR"),this.name="ValidationError"}}class n extends r{constructor(e){super(`${e} not found`,404,"NOT_FOUND"),this.name="NotFoundError"}}}};var s=require("../../../../webpack-runtime.js");s.C(e);var t=e=>s(s.s=e),r=s.X(0,[921,714,929,906],()=>t(53e3));module.exports=r})();